graph TB
    C1[User submits email+password] --> C2[Gateway: IP-based rate limit<br/>login:ip 60/10min]
    C2 --> C3[POST /auth/login]
    
    C3 --> C3A[Redis: Check account lockout<br/>GET login_lock:email]
    C3A -->|Locked| C3B{Check lock expiry}
    C3B -->|Still locked| C3C[429 Too Many Requests<br/>Retry-After: X seconds<br/>Account temporarily locked]
    C3B -->|Expired| C3D[Redis: DEL login_lock:email]
    C3D --> C4
    C3A -->|Not locked| C4[SELECT FROM users<br/>WHERE email=?]
    
    C4 -->|Not found| C5A[Redis: INCR login_attempts:email]
    C5A --> C5B[Calculate progressive delay<br/>delay = min 2^attempts, 60 seconds]
    C5B --> C5C[429 Too Many Requests<br/>Retry-After: delay<br/>message: Invalid credentials]
    
    C4 -->|Found| C4A[Redis: GET login_attempts:email]
    C4A --> C4B{Check attempt count}
    C4B -->|>= 5 attempts| C4C[Redis: SET login_lock:email<br/>lockUntil=now+15min<br/>TTL=15min]
    C4C --> C4D[429 Account Locked<br/>Retry-After: 900<br/>Email sent: Account locked notification]
    
    C4B -->|< 5 attempts| C6[Verify password<br/>BCrypt.checkpw]
    C6 -->|Mismatch| C7A[Redis: INCR login_attempts:email<br/>TTL=15min sliding window]
    C7A --> C7B{Check new count}
    C7B -->|< 5| C7C[Calculate progressive delay<br/>delay = 2^attempt seconds]
    C7C --> C7D[INSERT INTO failed_login_audit<br/>email, ip, timestamp]
    C7D --> C7E[429 Too Many Requests<br/>Retry-After: delay<br/>message: Invalid credentials<br/>attemptsRemaining: 5-count]
    
    C7B -->|>= 5| C7F[Redis: SET login_lock:email<br/>lockUntil=now+15min]
    C7F --> C7G[INSERT INTO account_lock_audit]
    C7G --> C7H[Publish Kafka: ACCOUNT_LOCKED event]
    C7H --> C7I[429 Account Locked<br/>Locked for 15 minutes]
    
    C6 -->|Match| C8[Redis: DEL login_attempts:email]
    C8 --> C8A{Check email verified}
    C8A -->|status != EMAIL_VERIFIED| C9[403 Email not verified]
    C8A -->|Verified| C10[Generate login session<br/>sessionId = UUID v4]

    C10 --> C10A[Calculate device fingerprint<br/>ipHash = SHA256 ip<br/>uaHash = SHA256 User-Agent]
    C10A --> C11[Store session metadata<br/>Redis: session:sessionId<br/>userId, email, ipHash, uaHash<br/>createdAt, TTL=5min]
    C11 --> C11A[Initialize OTP resend counter<br/>Redis: otp_resend:sessionId = 0<br/>TTL=5min]
    C11A --> C12[Generate PARTIAL JWT<br/>RS256 signed]
    C12 --> C13[JWT Claims:<br/>sub=userId<br/>email=email<br/>aud=algoshare-gateway<br/>token_type=PRE_AUTH<br/>mfa=false<br/>sessionId=sessionId<br/>exp=now+5min<br/>iss=algoshare-auth<br/>jti=unique-jti]

    C13 --> C14[Publish Kafka Event<br/>Topic: auth.events<br/>Event: LOGIN_OTP_REQUESTED]
    C14 --> C15[200 OK<br/>status: OTP_REQUIRED<br/>partialJwt: eyJhbGc...<br/>sessionId: xyz789]

    C14 -.Async.-> C16[Notification Service<br/>Kafka Consumer]
    C16 --> C17[Generate OTP<br/>6-digit random: 123456]
    C17 --> C18[Encrypt OTP<br/>AES-256-GCM with session key]
    C18 --> C19[Store in Redis<br/>Key: otp:sessionId<br/>Value: encrypted_otp<br/>TTL=5min]
    C19 --> C20[Load email template<br/>Thymeleaf: login-otp.html]
    C20 --> C21[Publish to RabbitMQ<br/>Queue: email.outbound]

    C21 -.Async.-> C22[Email Worker]
    C22 --> C23[Send OTP email via SES]
    C23 --> C24[INSERT INTO email_delivery_log]

    C7H -.Async.-> C7J[Send account lock notification email]

    style C1 fill:#fff3e0
